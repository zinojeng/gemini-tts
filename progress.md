# Gemini TTS 開發進度記錄

## 2024-12-19 更新

### 問題描述
在多講者模式下，當使用範例類別（如「有聲書朗讀」、「客服對話」等）時，系統會將描述性文字和講者標籤都唸出來，而不是只唸出實際的對話內容。

**具體問題：**
- 輸入文本包含「客服和顧客的對話：」這類描述時，TTS 會將其當作語音內容
- 講者標籤（如「客服：」、「顧客：」）也會被唸出來
- 講者名稱不匹配導致 API 回應錯誤

### 解決方案

#### 1. 實現文本預處理功能
- 創建 `clean_dialogue_text()` 函數來清理對話文本
- 自動過濾掉不包含實際對話的描述性文字
- 只保留以講者名稱開頭且包含對話內容的行

#### 2. 自動識別講者名稱
- 當使用預設的「講者1」、「講者2」時，自動從範例文本中提取實際講者名稱
- 智能識別對話格式，排除只有冒號但沒有內容的描述行
- 支援中文冒號（：）和英文冒號（:）

#### 3. 改善使用者體驗
- 為講者 2 設定不同的預設語音（Puck），與講者 1（Zephyr）區分
- 添加調試信息展示區，顯示清理後的文本和識別的講者
- 提供詳細的錯誤訊息和提示

#### 4. 錯誤處理
- 檢查清理後的文本是否為空
- 驗證 API 回應的有效性
- 提供有用的錯誤訊息幫助使用者排除問題

### 技術實現細節

```python
def clean_dialogue_text(text: str, speakers: List[str]) -> tuple:
    """
    清理多講者對話文本
    - 自動識別文本中的實際講者名稱
    - 過濾掉描述性文字
    - 返回清理後的文本和實際講者列表
    """
```

### 測試結果
✅ 「播客對話」範例正常運作
✅ 「有聲書朗讀」範例成功過濾描述文字
✅ 「客服對話」範例正確識別講者
✅ 「教育內容」範例正常生成語音

### 後續優化建議
1. 支援更多講者（目前限制為 2 個）
2. 添加講者語音預覽功能
3. 支援自定義講者語音映射
4. 優化講者識別算法，支援更多格式

### 相關檔案
- `gemini_tts_app.py` - 主要應用程式（已更新）
- `gemini_tts_cli.py` - 命令列版本（待同步更新）

### Git 提交記錄
- Commit: 3d9fa1e
- Message: 修正多講者模式：自動識別講者名稱並過濾描述性文字
- Date: 2024-12-19 

## 2024-12-26

### 問題：多講者模式會將 Style instructions 內容唸出來

**問題描述：**
當使用多講者模式時，系統會將以下內容都當作語音唸出來：
- "客服和顧客的對話："
- "客服："、"顧客："等講者標籤
- Style instructions 的內容

**解決方案：**

1. **文本預處理功能**
   - 在 `clean_dialogue_text` 函數中實現了智能文本清理
   - 自動識別並過濾掉描述性文字（如"客服和顧客的對話："）
   - 只保留實際的對話內容

2. **講者識別改進**
   - 實現了自動從範例文本中提取講者名稱
   - 修正了講者順序問題（從字母排序改為出現順序）
   - 支援冒號的全形（：）和半形（:）格式

3. **風格設定簡化**
   - 從複雜的多選風格改為單一風格選擇
   - 添加了「自訂」選項，讓用戶輸入個性化風格
   - 風格指令格式：`講者名用風格語氣說話`

4. **調試信息增強**
   - 顯示清理後的對話文本
   - 顯示實際傳送給 API 的內容
   - 顯示每個講者的語音和風格配置

### 累積生成對話功能

**功能描述：**
用戶可以通過多次點擊「生成對話建議」按鈕，在現有對話基礎上累積生成更多內容。

**實現細節：**

1. **修改 `generate_prompt_suggestion` 函數**
   - 添加 `existing_text` 參數來接收現有文本
   - 根據現有對話的長度（對話輪數）生成不同的後續內容
   - 支援所有範例類別：播客對話、有聲書朗讀、客服對話、教育內容

2. **使用 Streamlit session_state**
   - 單一講者模式使用 `single_text_content` 鍵
   - 多講者模式使用 `multi_text_content` 鍵
   - 保持文本框內容在按鈕點擊後不會重置

3. **智能內容生成**
   - 0-6 句對話：生成開場和基礎互動
   - 6-10 句對話：深入主題討論
   - 10+ 句對話：總結和結束語
   - 每個階段的內容都與前文連貫

4. **支援的範例類別**
   - **播客對話**：從歡迎到深入討論再到感謝結束
   - **有聲書朗讀**：從場景設定到情節發展再到高潮結局
   - **客服對話**：從問題提出到解答再到確認結束
   - **教育內容**：從概念介紹到深入解釋再到總結回顧

**使用方式：**
1. 選擇範例類別
2. 點擊「生成對話建議」生成初始對話
3. 再次點擊按鈕，在現有內容基礎上添加更多對話
4. 可以多次點擊，直到生成完整的對話內容

## 技術要點

- 使用正則表達式匹配講者格式
- 支援中英文冒號
- 自動過濾非對話行
- 保持對話的連貫性和邏輯性
